<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Attendance - Smart Attendance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/png" href="https://img.icons8.com/ios/50/ffffff/attendance-mark.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar {
      transition: all 0.3s ease;
    }
    .main-content {
      margin-left: 16rem;
      transition: all 0.3s ease;
    }
    .active-tab {
      background-color: #f0f9ff;
      border-left: 4px solid #0ea5e9;
      color: #0369a1;
    }
    .stat-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .attendance-present {
      background-color: #dcfce7;
      color: #166534;
    }
    .attendance-absent {
      background-color: #fee2e2;
      color: #991b1b;
    }
    .attendance-late {
      background-color: #fef3c7;
      color: #92400e;
    }
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg border-r border-gray-200 flex flex-col">
    <!-- Logo -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-teal-500 to-blue-600 rounded-lg flex items-center justify-center">
          <i class="fas fa-user-check text-white text-lg"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-gray-800">Smart Attendance</h1>
          <p class="text-xs text-gray-500">Student Panel</p>
        </div>
      </div>
    </div>
    
    <!-- Navigation - Only My Attendance Tab -->
    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="#" class="nav-item active-tab flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors duration-200" data-tab="attendance">
        <i class="fas fa-clipboard-check w-5 text-center"></i>
        <span>My Attendance</span>
      </a>
    </nav>
    
    <!-- User Profile -->
    <div class="p-4 border-t border-gray-200">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center">
          <i class="fas fa-user-graduate text-white"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-gray-900 truncate" id="studentName">Loading...</p>
          <p class="text-xs text-gray-500 truncate">Student</p>
        </div>
        <button id="logoutBtn" class="text-gray-500 hover:text-red-500 transition-colors duration-200" title="Logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="flex items-center justify-between px-8 py-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-800" id="pageTitle">My Attendance</h2>
          <p class="text-gray-600" id="pageSubtitle">View your attendance history and statistics</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm font-medium text-gray-900" id="currentDate">Loading...</p>
            <p class="text-xs text-gray-500" id="currentTime">Loading...</p>
          </div>
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center text-white font-medium">
            <i class="fas fa-user-graduate"></i>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Student Content -->
    <main class="p-8">
      <!-- My Attendance Tab -->
      <div id="attendance" class="tab-content">
        <!-- Attendance Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h4 class="text-2xl font-bold text-gray-800 mb-2" id="totalPresent">0</h4>
            <p class="text-sm text-gray-600">Present Days</p>
          </div>
          <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-times text-red-600 text-2xl"></i>
            </div>
            <h4 class="text-2xl font-bold text-gray-800 mb-2" id="totalAbsent">0</h4>
            <p class="text-sm text-gray-600">Absent Days</p>
          </div>
          <div class="stat-card bg-white rounded-xl shadow-sm border border-gray-100 p-6 text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-percentage text-blue-600 text-2xl"></i>
            </div>
            <h4 class="text-2xl font-bold text-gray-800 mb-2" id="attendancePercentage">0%</h4>
            <p class="text-sm text-gray-600">Overall Attendance</p>
          </div>
        </div>

        <!-- Subject-wise Statistics -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">Subject-wise Attendance</h4>
          <div id="subjectStats" class="space-y-4">
            <div class="text-center py-8 text-gray-500">
              <div class="loading-spinner mx-auto mb-4"></div>
              <p>Loading subject statistics...</p>
            </div>
          </div>
        </div>
        
        <!-- Attendance History -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <div class="flex items-center justify-between mb-6">
            <h4 class="text-lg font-semibold text-gray-800">Attendance History</h4>
            <div class="flex space-x-2">
              <select id="attendanceFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="all">All Subjects</option>
                <option value="last7days">Last 7 Days</option>
                <option value="last30days">Last 30 Days</option>
                <option value="thismonth">This Month</option>
              </select>
              <button id="refreshAttendance" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                <i class="fas fa-sync-alt mr-2"></i>Refresh
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Date</th>
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Subject</th>
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Class</th>
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Teacher</th>
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Status</th>
                  <th class="text-left py-3 px-4 text-sm font-medium text-gray-700">Remarks</th>
                </tr>
              </thead>
              <tbody id="attendanceHistory">
                <tr>
                  <td colspan="6" class="py-8 text-center text-gray-500">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p>Loading attendance records...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="pagination" class="mt-4 flex justify-between items-center hidden">
            <button id="prevPage" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200">
              <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            <span class="text-sm text-gray-600" id="pageInfo">Page 1 of 1</span>
            <button id="nextPage" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors duration-200">
              Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="app.js"></script>
  <script>
    // Check authentication
    if (!checkAuth('student')) {
      window.location.href = 'index.html';
    }

    // Global variables
    let currentAttendanceData = [];
    let currentPage = 1;
    const recordsPerPage = 10;

    // Initialize student dashboard
    document.addEventListener('DOMContentLoaded', function() {
      const currentUser = getSession();
      if (currentUser) {
        document.getElementById('studentName').textContent = currentUser.name || 'Student User';
      }
      
      // Update date and time
      updateDateTime();
      setInterval(updateDateTime, 60000);
      
      // Load attendance data
      loadAttendanceData();
      
      // Setup event listeners
      setupEventListeners();
    });
    
    function updateDateTime() {
      const now = new Date();
      document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
    
    function setupEventListeners() {
      // Logout
      document.getElementById('logoutBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to logout?')) {
          logout();
        }
      });

      // Refresh button
      document.getElementById('refreshAttendance').addEventListener('click', function() {
        loadAttendanceData();
      });

      // Filter change
      document.getElementById('attendanceFilter').addEventListener('change', function() {
        currentPage = 1;
        filterAndDisplayAttendance();
      });

      // Pagination
      document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          displayAttendancePage();
        }
      });

      document.getElementById('nextPage').addEventListener('click', function() {
        const totalPages = Math.ceil(currentAttendanceData.length / recordsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          displayAttendancePage();
        }
      });
    }

    async function loadAttendanceData() {
      try {
        // Show loading states
        showLoadingStates();
        
        // Load attendance data
        const attendance = await getStudentAttendance();
        
        if (attendance && Array.isArray(attendance)) {
          currentAttendanceData = attendance;
          updateAttendanceSummary(attendance);
          updateSubjectStatistics(attendance);
          filterAndDisplayAttendance();
        } else {
          throw new Error('Invalid attendance data received');
        }
        
      } catch (error) {
        console.error('Failed to load attendance data:', error);
        showErrorState('Failed to load attendance data. Please try again.');
      }
    }

    function showLoadingStates() {
      document.getElementById('attendanceHistory').innerHTML = `
        <tr>
          <td colspan="6" class="py-8 text-center text-gray-500">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p>Loading attendance records...</p>
          </td>
        </tr>
      `;
      
      document.getElementById('subjectStats').innerHTML = `
        <div class="text-center py-4 text-gray-500">
          <div class="loading-spinner mx-auto mb-4"></div>
          <p>Loading subject statistics...</p>
        </div>
      `;
    }

    function showErrorState(message) {
      document.getElementById('attendanceHistory').innerHTML = `
        <tr>
          <td colspan="6" class="py-8 text-center text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-4"></i>
            <p>${message}</p>
            <button onclick="loadAttendanceData()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Retry
            </button>
          </td>
        </tr>
      `;
    }

    function updateAttendanceSummary(attendance) {
      const totalRecords = attendance.length;
      const presentCount = attendance.filter(a => a.status === 'present').length;
      const absentCount = attendance.filter(a => a.status === 'absent').length;
      const attendancePercent = calculateAttendancePercentage(presentCount, totalRecords);

      document.getElementById('totalPresent').textContent = presentCount;
      document.getElementById('totalAbsent').textContent = absentCount;
      document.getElementById('attendancePercentage').textContent = `${attendancePercent}%`;
    }

    function updateSubjectStatistics(attendance) {
      // Group attendance by subject
      const subjectStats = {};
      
      attendance.forEach(record => {
        const subjectName = record.subject?.name || 'Unknown Subject';
        const subjectCode = record.subject?.code || '';
        
        if (!subjectStats[subjectName]) {
          subjectStats[subjectName] = {
            total: 0,
            present: 0,
            code: subjectCode
          };
        }
        
        subjectStats[subjectName].total++;
        if (record.status === 'present') {
          subjectStats[subjectName].present++;
        }
      });

      // Display subject statistics
      const subjectStatsDiv = document.getElementById('subjectStats');
      
      if (Object.keys(subjectStats).length === 0) {
        subjectStatsDiv.innerHTML = `
          <div class="text-center py-4 text-gray-500">
            <i class="fas fa-book text-2xl mb-2 opacity-50"></i>
            <p>No subject data available</p>
          </div>
        `;
        return;
      }

      subjectStatsDiv.innerHTML = Object.entries(subjectStats).map(([subjectName, stats]) => {
        const percentage = stats.total > 0 ? Math.round((stats.present / stats.total) * 100) : 0;
        const colorClass = percentage >= 85 ? 'bg-green-600' : 
                          percentage >= 75 ? 'bg-yellow-500' : 'bg-red-600';
        
        return `
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex justify-between text-sm mb-1">
                <span class="font-medium text-gray-800">${subjectName}</span>
                <span class="${percentage >= 85 ? 'text-green-600' : percentage >= 75 ? 'text-yellow-600' : 'text-red-600'} font-medium">
                  ${percentage}%
                </span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full ${colorClass}" style="width: ${percentage}%"></div>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                ${stats.present} present out of ${stats.total} classes
                ${stats.code ? ` â€¢ ${stats.code}` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function filterAndDisplayAttendance() {
      const filterValue = document.getElementById('attendanceFilter').value;
      let filteredData = [...currentAttendanceData];

      // Apply filters
      switch (filterValue) {
        case 'last7days':
          const sevenDaysAgo = new Date();
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
          filteredData = filteredData.filter(record => new Date(record.date) >= sevenDaysAgo);
          break;
        case 'last30days':
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          filteredData = filteredData.filter(record => new Date(record.date) >= thirtyDaysAgo);
          break;
        case 'thismonth':
          const now = new Date();
          const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
          filteredData = filteredData.filter(record => new Date(record.date) >= startOfMonth);
          break;
      }

      currentAttendanceData = filteredData;
      currentPage = 1;
      displayAttendancePage();
    }

    function displayAttendancePage() {
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = startIndex + recordsPerPage;
      const pageData = currentAttendanceData.slice(startIndex, endIndex);
      const totalPages = Math.ceil(currentAttendanceData.length / recordsPerPage);

      const tableBody = document.getElementById('attendanceHistory');
      const paginationDiv = document.getElementById('pagination');
      const pageInfo = document.getElementById('pageInfo');

      if (pageData.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="6" class="py-8 text-center text-gray-500">
              <i class="fas fa-clipboard-check text-2xl mb-2 opacity-50"></i>
              <p>No attendance records found</p>
              <p class="text-sm mt-1">Try selecting a different filter</p>
            </td>
          </tr>
        `;
        paginationDiv.classList.add('hidden');
        return;
      }

      tableBody.innerHTML = pageData.map(record => {
        const className = record.class ? `${record.class.name} - ${record.class.section}` : 'Unknown Class';
        const subjectName = record.subject?.name || 'Unknown Subject';
        const teacherName = record.markedBy || 'Unknown Teacher';
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors duration-200">
            <td class="py-3 px-4 text-sm font-medium">${formatDate(record.date)}</td>
            <td class="py-3 px-4 text-sm">
              <div class="font-medium text-gray-800">${subjectName}</div>
              ${record.subject?.code ? `<div class="text-xs text-gray-500">${record.subject.code}</div>` : ''}
            </td>
            <td class="py-3 px-4 text-sm">${className}</td>
            <td class="py-3 px-4 text-sm">${teacherName}</td>
            <td class="py-3 px-4 text-sm">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${
                record.status === 'present' ? 'attendance-present' : 
                record.status === 'absent' ? 'attendance-absent' : 'attendance-late'
              }">
                ${record.status ? record.status.charAt(0).toUpperCase() + record.status.slice(1) : 'Unknown'}
              </span>
            </td>
            <td class="py-3 px-4 text-sm text-gray-500">${record.remarks || '-'}</td>
          </tr>
        `;
      }).join('');

      // Update pagination
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = currentPage === totalPages;
      
      if (totalPages > 1) {
        paginationDiv.classList.remove('hidden');
      } else {
        paginationDiv.classList.add('hidden');
      }
    }

    // Utility functions
    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        return 'Invalid Date';
      }
    }

    // Auto-refresh every 5 minutes
    setInterval(() => {
      loadAttendanceData();
    }, 300000); // 5 minutes
  </script>
</body>
</html>